<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChittyOS Trust Engine | Real 6D Trust Scoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="https://chitty.cc/favicon.ico">
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-blue-400">ChittyOS Trust Engine</h1>
                    <span class="bg-green-600 text-xs px-2 py-1 rounded">REAL CALCULATIONS</span>
                </div>
                <div class="text-sm text-gray-400">
                    API: trust.chitty.cc
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8" x-data="trustApp()">

        <!-- Trust Calculator -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Real Trust Score Calculator</h2>
            <div class="grid md:grid-cols-2 gap-6">

                <!-- Input Form -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Entity ID or ChittyID</label>
                        <input
                            x-model="entityId"
                            @keyup.enter="calculateTrust"
                            type="text"
                            placeholder="alice or id.chitty.cc/ABC12345"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
                        >
                    </div>

                    <button
                        @click="calculateTrust"
                        :disabled="loading || !entityId"
                        class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 px-4 py-2 rounded font-medium transition-colors"
                    >
                        <span x-show="!loading">Calculate Real Trust Score</span>
                        <span x-show="loading">Calculating...</span>
                    </button>

                    <!-- Quick Examples -->
                    <div class="mt-4">
                        <p class="text-sm text-gray-400 mb-2">Quick test examples:</p>
                        <div class="space-y-1">
                            <button @click="entityId='alice'; calculateTrust()" class="block text-xs text-blue-400 hover:text-blue-300">alice (demo user)</button>
                            <button @click="entityId='id.chitty.cc/ABC12345'" class="block text-xs text-blue-400 hover:text-blue-300">id.chitty.cc/ABC12345 (ChittyID format)</button>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div x-show="trustScore">
                    <div class="bg-gray-700 rounded p-4">
                        <h3 class="font-semibold mb-3">Trust Score Results</h3>

                        <!-- Overall Score -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span>Overall Trust Score</span>
                                <span class="text-xl font-bold" :class="getScoreColor(trustScore?.trust_score)">
                                    <span x-text="trustScore?.trust_score?.toFixed(1)"></span>%
                                </span>
                            </div>
                            <div class="text-sm text-gray-400">
                                Level: <span x-text="trustScore?.chitty_level" class="text-blue-400"></span>
                            </div>
                        </div>

                        <!-- 6D Dimensions -->
                        <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                            <template x-for="(score, dimension) in trustScore?.dimensions" :key="dimension">
                                <div class="flex justify-between">
                                    <span x-text="dimension" class="capitalize"></span>
                                    <span x-text="score?.toFixed(1) + '%'" :class="getScoreColor(score)"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Output Scores -->
                        <div class="border-t border-gray-600 pt-3">
                            <div class="text-xs text-gray-400 mb-2">Output Scores:</div>
                            <template x-for="(score, type) in trustScore?.output_scores" :key="type">
                                <div class="flex justify-between text-sm">
                                    <span x-text="type.replace('_', ' ')" class="capitalize"></span>
                                    <span x-text="score?.toFixed(1) + '%'" :class="getScoreColor(score)"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Metadata -->
                        <div class="mt-3 text-xs text-gray-500">
                            <div>Confidence: <span x-text="(trustScore?.confidence * 100)?.toFixed(1) + '%'"></span></div>
                            <div>Data Points: <span x-text="trustScore?.data_points"></span></div>
                            <div>Calculated: <span x-text="new Date(trustScore?.timestamp).toLocaleString()"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div x-show="error" class="bg-red-900 border border-red-700 rounded p-4">
                    <h3 class="font-semibold text-red-400 mb-2">Error</h3>
                    <p class="text-sm" x-text="error"></p>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">User Management</h2>

            <!-- Create User -->
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium mb-3">Create New User</h3>
                    <div class="space-y-3">
                        <input
                            x-model="newUser.id"
                            type="text"
                            placeholder="User ID or ChittyID"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                        >
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center text-sm">
                                <input x-model="newUser.identity_verified" type="checkbox" class="mr-2">
                                Identity Verified
                            </label>
                            <select x-model="newUser.credential_type" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="blockchain_verified">Blockchain</option>
                                <option value="government_verified">Government</option>
                                <option value="passport_verified">Passport</option>
                            </select>
                        </div>
                        <button
                            @click="createUser"
                            class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-medium transition-colors text-sm"
                        >
                            Create User
                        </button>
                    </div>
                </div>

                <!-- Add Event -->
                <div>
                    <h3 class="font-medium mb-3">Add Trust Event</h3>
                    <div class="space-y-3">
                        <input
                            x-model="newEvent.user_id"
                            type="text"
                            placeholder="User ID"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                        >
                        <div class="grid grid-cols-2 gap-2">
                            <select x-model="newEvent.type" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="verification">Verification</option>
                                <option value="transaction">Transaction</option>
                                <option value="endorsement">Endorsement</option>
                                <option value="blockchain_transaction">Blockchain TX</option>
                            </select>
                            <select x-model="newEvent.outcome" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="positive">Positive</option>
                                <option value="neutral">Neutral</option>
                                <option value="negative">Negative</option>
                            </select>
                        </div>
                        <input
                            x-model="newEvent.description"
                            type="text"
                            placeholder="Event description"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"
                        >
                        <button
                            @click="addEvent"
                            class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-medium transition-colors text-sm"
                        >
                            Add Event
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Status -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">API Status</h2>
            <div x-show="apiStatus">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <div class="text-gray-400">Status</div>
                        <div class="font-medium" :class="apiStatus?.status === 'healthy' ? 'text-green-400' : 'text-red-400'">
                            <span x-text="apiStatus?.status"></span>
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-400">Users</div>
                        <div class="font-medium text-blue-400" x-text="apiStatus?.database_users"></div>
                    </div>
                    <div>
                        <div class="text-gray-400">Engine</div>
                        <div class="font-medium text-green-400" x-text="apiStatus?.engine"></div>
                    </div>
                    <div>
                        <div class="text-gray-400">Real Data</div>
                        <div class="font-medium" :class="apiStatus?.real_calculations ? 'text-green-400' : 'text-red-400'">
                            <span x-text="apiStatus?.real_calculations ? 'YES' : 'NO'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function trustApp() {
            return {
                // Configuration
                apiUrl: window.location.hostname.includes('chitty.cc') ? 'https://trust.chitty.cc' : 'http://localhost:5000',

                // State
                entityId: '',
                loading: false,
                trustScore: null,
                error: null,
                apiStatus: null,

                // Forms
                newUser: {
                    id: '',
                    identity_verified: true,
                    credential_type: 'blockchain_verified'
                },
                newEvent: {
                    user_id: '',
                    type: 'verification',
                    outcome: 'positive',
                    description: ''
                },

                async init() {
                    await this.checkApiStatus();
                },

                async checkApiStatus() {
                    try {
                        const response = await fetch(`${this.apiUrl}/api/health`);
                        this.apiStatus = await response.json();
                    } catch (err) {
                        console.error('API health check failed:', err);
                    }
                },

                async calculateTrust() {
                    if (!this.entityId.trim()) return;

                    this.loading = true;
                    this.error = null;
                    this.trustScore = null;

                    try {
                        const response = await fetch(`${this.apiUrl}/api/trust/${encodeURIComponent(this.entityId)}`);
                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || data.error || 'Trust calculation failed');
                        }

                        this.trustScore = data;
                        await this.checkApiStatus(); // Refresh status
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async createUser() {
                    if (!this.newUser.id.trim()) return;

                    try {
                        const userData = {
                            identity_verified: this.newUser.identity_verified,
                            credentials: [this.newUser.credential_type],
                            channels: ['email', 'phone'],
                            connections: ['trusted_network']
                        };

                        const response = await fetch(`${this.apiUrl}/api/users/${encodeURIComponent(this.newUser.id)}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(userData)
                        });

                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'User creation failed');

                        alert(`User ${this.newUser.id} created successfully!`);
                        this.newUser = { id: '', identity_verified: true, credential_type: 'blockchain_verified' };
                        await this.checkApiStatus();
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                },

                async addEvent() {
                    if (!this.newEvent.user_id.trim()) return;

                    try {
                        const eventData = {
                            type: this.newEvent.type,
                            outcome: this.newEvent.outcome,
                            channel: 'direct',
                            description: this.newEvent.description
                        };

                        const response = await fetch(`${this.apiUrl}/api/users/${encodeURIComponent(this.newEvent.user_id)}/events`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        });

                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'Event creation failed');

                        alert(`Event added for ${this.newEvent.user_id}!`);
                        this.newEvent = { user_id: '', type: 'verification', outcome: 'positive', description: '' };
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                },

                getScoreColor(score) {
                    if (score >= 80) return 'text-green-400';
                    if (score >= 60) return 'text-yellow-400';
                    if (score >= 40) return 'text-orange-400';
                    return 'text-red-400';
                }
            }
        }
    </script>
</body>
</html>